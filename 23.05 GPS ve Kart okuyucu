#include <Arduino.h>
#include <WiFi.h>
#include <Firebase_ESP_Client.h>
#include <SPI.h>
#include <MFRC522.h>
#include <time.h>
#include <Preferences.h>
#include <TinyGPS++.h>
#include <SoftwareSerial.h>

#define WIFI_SSID_1 "Samsung t50"
#define WIFI_PASSWORD_1 "SAMM2023TR.."
#define WIFI_SSID_2 "VodafoneNet-RBE84T"
#define WIFI_PASSWORD_2 "SAMM2023TR."
#define WIFI_SSID_3 "trlink_cbce"
#define WIFI_PASSWORD_3 "12345678"
#define WIFI_SSID_4 "SAM Mekanik Enerji"
#define WIFI_PASSWORD_4 "SAM2024TR."
#define WIFI_SSID_5 "RUT241_56EC"
#define WIFI_PASSWORD_5 "Si7t1PRs"

#define MAX_WIFI_RETRIES 5

#define API_KEY "AIzaSyBnEwHEpxCQkJ48H4dUNHimrWkfg_FbEY8"
#define USER_EMAIL "baha.bygld@gmail.com"
#define USER_PASSWORD "224223"
#define DATABASE_URL "https://sam-kart2-default-rtdb.europe-west1.firebasedatabase.app/"
#define RST_PIN     15
#define SS_PIN      5
#define MOSI_PIN    23
#define MISO_PIN    19
#define SCK_PIN     18
#define LED_PIN     13

int RXPin = 26;
int TXPin = 27;
int GPSBaud = 9600;

TinyGPSPlus gps;
SoftwareSerial gpsSerial(RXPin, TXPin);
MFRC522 mfrc522(SS_PIN, RST_PIN);

FirebaseData fbdo;
FirebaseAuth auth;
FirebaseConfig config;

String uid;
String databasePath;
String parentPath;

Preferences preferences;

SemaphoreHandle_t semafor;

unsigned long powerOnTime = 0;
bool powerOn = false;

void initWiFi(void * parameter) {
  int attempt = 1;
  do {
    WiFi.begin(
      attempt == 1 ? WIFI_SSID_1 : 
      attempt == 2 ? WIFI_SSID_2 : 
      attempt == 3 ? WIFI_SSID_3 :
      attempt == 4 ? WIFI_SSID_4 :
      WIFI_SSID_5,
      attempt == 1 ? WIFI_PASSWORD_1 : 
      attempt == 2 ? WIFI_PASSWORD_2 : 
      attempt == 3 ? WIFI_PASSWORD_3 :
      attempt == 4 ? WIFI_PASSWORD_4 :
      WIFI_PASSWORD_5
    );

    Serial.printf("WiFi'ye bağlanılıyor... Attempt %d\n", attempt);
    unsigned long startTime = millis();
    while (WiFi.status() != WL_CONNECTED && millis() - startTime < 15000) {
      Serial.print('.');
      delay(1000);
    }
    if (WiFi.status() == WL_CONNECTED) {
      Serial.printf("\nWiFi'ye başarıyla bağlandı. SSID: %s\n", WiFi.SSID().c_str());
      xSemaphoreGive(semafor);
      vTaskDelete(NULL);
    }
    attempt++;
  } while (attempt <= 2 && WiFi.status() != WL_CONNECTED);

  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("\nHerhangi bir WiFi ağına bağlanılamadı.");
    vTaskDelete(NULL);
  }
}

void wifiCheck(void * parameter) {
  vTaskDelay(7000 / portTICK_PERIOD_MS);
  for (;;) {
    if (xSemaphoreTake(semafor, portMAX_DELAY) == pdTRUE) {
      config.api_key = API_KEY;
      auth.user.email = USER_EMAIL;
      auth.user.password = USER_PASSWORD;
      config.database_url = DATABASE_URL;

      Firebase.reconnectWiFi(true);
      fbdo.setResponseSize(4096);
      config.max_token_generation_retry = 5;
      Firebase.begin(&config, &auth);

      Serial.println("Kullanıcı UID alınıyor...");
      while ((auth.token.uid) == "") {
        Serial.print('.');
        delay(1000);
      }
      uid = auth.token.uid.c_str();
      Serial.print("Kullanıcı UID: ");
      Serial.println(uid);

      databasePath = "/UsersData/" + uid + "/readings";

      Serial.println("WiFi bağlantısı sağlandı, flaş bellekten veriler yükleniyor...");

      int count = preferences.getInt("count", 0);
      Serial.print("Flaş bellekteki kart sayısı: ");
      Serial.println(count);

      for (int i = 0; i < count; i++) {
        String keyUid = "uid" + String(i);
        String keyTime = "time" + String(i);
        String uidString = preferences.getString(keyUid.c_str(), "");
        String timeString = preferences.getString(keyTime.c_str(), "");
        if (uidString != "" && timeString != "") {
          parentPath = databasePath + "/" + String(millis());
          FirebaseJson json;
          json.set("uid", uidString);
          json.set("time", timeString);

          char latBuffer[10];
          char lonBuffer[10];

          if (gps.location.isValid()) {
            dtostrf(gps.location.lat(), 6, 6, latBuffer);
            dtostrf(gps.location.lng(), 6, 6, lonBuffer);
            json.set("latitude", latBuffer);
            json.set("longitude", lonBuffer);
          } else {
            json.set("latitude", "");
            json.set("longitude", "");
          }

          if (Firebase.RTDB.setJSON(&fbdo, parentPath.c_str(), &json)) {
            Serial.printf("JSON ayarlandı ve veri başarıyla gönderildi... %s\n", Firebase.RTDB.setJSON(&fbdo, parentPath.c_str(), &json) ? "ok" : fbdo.errorReason().c_str());
            preferences.remove(keyUid.c_str());
            preferences.remove(keyTime.c_str());
            Serial.println("Flaş bellekten veri silindi.");
            delay(1000);
          } else {
            Serial.printf("Veri gönderme hatası: %s\n", fbdo.errorReason().c_str());
          }
        }
      }

      preferences.putInt("count", 0);
    }
    vTaskDelay(5000 / portTICK_PERIOD_MS);
  }
}

bool waitForWiFiConnection() {
  unsigned long startTime = millis();
  while (WiFi.status() != WL_CONNECTED && millis() - startTime < 15000) {
    delay(500);
    Serial.print(".");
  }
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("WiFi'ye başarıyla bağlandı.");
    return true;
  } else {
    Serial.println("WiFi'ye bağlanılamadı.");
    return false;
  }
}

String lastUID = "";
String uniqueNode = String(millis());

void readRFIDCard(void * param) {
  for (;;) {
    if ( !mfrc522.PICC_IsNewCardPresent()) {
      delay(50);
      continue;
    }
    if ( !mfrc522.PICC_ReadCardSerial()) {
      delay(50);
      continue;
    }

    digitalWrite(LED_PIN, HIGH);
    delay(1000);
    digitalWrite(LED_PIN, LOW);

    String content = "";
    for (byte i = 0; i < mfrc522.uid.size; i++) {
      content.concat(String(mfrc522.uid.uidByte[i] < 0x10 ? "0" : ""));
      content.concat(String(mfrc522.uid.uidByte[i], HEX));
    }
    content.toUpperCase();

    if (content == lastUID) {
      Serial.println("Aynı kart art arda okutulamaz.");
      delay(1000);
      continue;
    }

    lastUID = content;

    String uniqueNode = String(millis());

    FirebaseJson json;

    if (gps.location.isValid()) {
      char latBuffer[10];
      char lonBuffer[10];
      dtostrf(gps.location.lat(), 6, 6, latBuffer);
      dtostrf(gps.location.lng(), 6, 6, lonBuffer);
      json.set("latitude", latBuffer);
      json.set("longitude", lonBuffer);
    } else {
      json.set("latitude", "");
      json.set("longitude", "");
    }

    json.set("UID", content);
    json.set("elapsed_time", (millis() - powerOnTime) / 1000);

    if (WiFi.status() == WL_CONNECTED) {
      time_t now;
      struct tm timeinfo;
      time(&now);
      localtime_r(&now, &timeinfo);
      char timeString[25];
      strftime(timeString, sizeof(timeString), "%Y-%m-%d %H:%M:%S", &timeinfo);
      json.set("timestamp", timeString);
    }

    String userPath = "/UsersData/" + uid + "/readings/" + content + "_" + uniqueNode;

    if (Firebase.ready()) {
      if (Firebase.RTDB.setJSON(&fbdo, userPath.c_str(), &json)) {
        Serial.println("Data sent to Firebase successfully!");
      } else {
        Serial.println("Failed to send data to Firebase.");
        Serial.println(fbdo.errorReason());
      }
    } else {
      int count = preferences.getInt("count", 0);
      String keyUid = "uid" + String(count);
      String keyTime = "time" + String(count);
      preferences.putString(keyUid.c_str(), content);
      preferences.putString(keyTime.c_str(), String((millis() - powerOnTime) / 1000));
      count++;
      preferences.putInt("count", count);
      Serial.println("Data saved to flash memory.");
    }

    delay(1000);
  }
}

void displayInfo() {
  if (gps.location.isValid()) {
    Serial.print("Latitude: ");
    Serial.println(gps.location.lat(), 6);
    Serial.print("Longitude: ");
    Serial.println(gps.location.lng(), 6);
    Serial.print("Altitude: ");
    Serial.println(gps.altitude.meters());
  } else {
    Serial.println("Location: Not Available");
  }

  Serial.print("Date: ");
  if (gps.date.isValid()) {
    Serial.print(gps.date.month());
    Serial.print("/");
    Serial.print(gps.date.day());
    Serial.print("/");
    Serial.println(gps.date.year());
  } else {
    Serial.println("Not Available");
  }

  Serial.print("Time: ");
  if (gps.time.isValid()) {
    if (gps.time.hour() < 10) Serial.print(F("0"));
    Serial.print(gps.time.hour());
    Serial.print(":");
    if (gps.time.minute() < 10) Serial.print(F("0"));
    Serial.print(gps.time.minute());
    Serial.print(":");
    if (gps.time.second() < 10) Serial.print(F("0"));
    Serial.println(gps.time.second());
  } else {
    Serial.println("Not Available");
  }
  Serial.println();
}

void setup() {
  Serial.begin(9600);
  semafor = xSemaphoreCreateBinary();

  pinMode(LED_PIN, OUTPUT);

  preferences.begin("my-app", false);

  gpsSerial.begin(GPSBaud);

  xTaskCreatePinnedToCore(
    initWiFi,
    "InitWiFi",
    10000,
    NULL,
    1,
    NULL,
    0
  );

  xTaskCreatePinnedToCore(
    wifiCheck,
    "WiFiCheck",
    10000,
    NULL,
    1,
    NULL,
    0
  );

  xTaskCreatePinnedToCore(
    readRFIDCard,
    "RFIDCard",
    10000,
    NULL,
    1,
    NULL,
    0
  );

  SPI.begin(SCK_PIN, MISO_PIN, MOSI_PIN, SS_PIN);
  mfrc522.PCD_Init();

  configTime(3 * 3600, 0, "pool.ntp.org");

  powerOnTime = millis();
  powerOn = true;
}

void loop() {
  unsigned long currentMillis = millis();
  unsigned long elapsedTime = currentMillis - powerOnTime;
  Serial.print("Elapsed Time (s): ");
  Serial.println(elapsedTime / 1000);

  while (gpsSerial.available() > 0)
    if (gps.encode(gpsSerial.read()))
      displayInfo();

  vTaskDelay(100 / portTICK_PERIOD_MS);
}
